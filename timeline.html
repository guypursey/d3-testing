<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<title>Chronological Diagram of Asia</title>
		<script type="text/javascript" src="//d3js.org/d3.v3.min.js"></script>
		<link rel="stylesheet" href="http://colorbrewer2.org/export/colorbrewer.css">
		<style type="text/css">
		.chart {
			shape-rendering: crispEdges;
		}

		.mini text {
			font: 9px sans-serif;
		}

		.main text {
			font: 12px sans-serif;
		}

		.miniItem0 {
			fill: darksalmon;
			stroke-width: 6;
			//opacity: 0.5;
		}

		.miniItem1 {
			fill: darkolivegreen;
			fill-opacity: .7;
			stroke-width: 6;
		}

		.miniItem2 {
			fill: slategray;
			fill-opacity: .7;
			stroke-width: 6;
		}

		.brush .extent {
			stroke: gray;
			fill: dodgerblue;
			fill-opacity: .365;
		}

		.axis {
		  font: 10px sans-serif;
		}

		.axis path,
		.axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		}
/*
		.x {
			position: absolute;
			bottom: 0;
		}
*/
		</style>
	</head>
	<body>
		<script>
		var m = [20, 15, 15, 120] //top right bottom left
		var w = 960 - m[1] - m[3]
		var h = 500 - m[0] - m[2]
		var f = 20
		var miniHeight = h / 6
		var mainHeight = h - miniHeight

		timeBegin = new Date("0000")
		timeEnd = new Date("2000")

		var x = d3.time.scale()
			      .range([0, w])

		var t = d3.time.scale()
			      .range([0, w])

		var y1 = d3.scale.linear()
			       .range([0, mainHeight])

		var y2 = d3.scale.linear()
			       .range([0, miniHeight])

		var xAxis = d3.svg.axis()
			          .scale(x)
			          .orient("bottom")
			          //.ticks(d3.time.years, 100)
			          //.tickFormat(d3.time.format("%Y"))
			          .tickSize(5)
			          .tickPadding(1)

		var tAxis = d3.svg.axis()
			          .scale(t)
			          .orient("bottom")
			          //.ticks(d3.time.years, 100)
			          //.tickFormat(d3.time.format("%Y"))
			          .tickSize(5)
			          .tickPadding(1)

		var getMainItemHeight = d => .8 * y1(1)
		var getMiniItemHeight = d => .8 * y2(1)
		var brewedColorClass = "Spectral"

		var chart = d3.select("body")
			          .append("svg")
			          .attr("width", w + m[1] + m[3])
			          .attr("height", h + m[0] + m[2])
			          .attr("class", `chart ${brewedColorClass}`)

		chart.append("defs").append("clipPath")
			 .attr("id", "clip")
			 .append("rect")
			 .attr("width", w)
			 .attr("height", mainHeight)

		var main = chart.append("g")
			            .attr("transform", `translate(${m[3]}, ${m[0]})`)
			            .attr("width", w)
			            .attr("height", mainHeight)
			            .attr("class", "main")

		var mini = chart.append("g")
			            .attr("transform", `translate(${m[3]}, ${mainHeight + m[0]})`)
			            .attr("width", w)
			            .attr("height", miniHeight)
			            .attr("class", "mini")

		var focus = main.append("g")
			           .attr("class", "focus")

		focus.append("g")
			 .attr("class", "t axis")
			 .call(tAxis)

		var lanesKey = {}
		var lanes = []
		var laneLength = 0

		var dataOptions = {
			"start": "start",
			"end": "end",
			"lane": "lane",
			"id": "id"
		}

		var dateformat = d3.time.format("%Y%m%d%H%M%S")
		var datestarttemplate = "00000101000000"
		var dateendtemplate = "99991231235959"

		var processData = v => {

			if (v[dataOptions.start]) {
				v.start = dateformat.parse(`${v[dataOptions.start]}${datestarttemplate.substr(v[dataOptions.start].length)}`)
				v.end = dateformat.parse(`${v[dataOptions.end] || v[dataOptions.start]}${dateendtemplate.substr(v[dataOptions.end].length || v[dataOptions.start].length)}`)

				if (!lanesKey.hasOwnProperty(v[dataOptions.lane])) {
					lanes.push(v[dataOptions.lane])
					lanesKey[v[dataOptions.lane]] = laneLength
					laneLength += 1
				}
				v.lanelabel = v[dataOptions.lane]
				v.lane = lanesKey[v[dataOptions.lane]]
				v.id = v[dataOptions.id]

				if (!v.start || !v.end) {
					v = null
				}

			} else {
				v = null
			}
			return v
		}

		d3.tsv("kingdoms-data.tsv", processData, function (error, items) {
			if (error) throw error

			var timeBegin = d3.min(items, d => d.start)
			var timeEnd = d3.max(items, d => d.end)

			x.domain([timeBegin, timeEnd])
			t.domain([timeBegin, timeEnd])
			y1.domain([0, laneLength])
			y2.domain([0, laneLength])

			//main lanes and texts
			main.append("g").selectAll(".laneLines")
				.data(items)
				.enter().append("line")
				.attr("t", m[1])
				.attr("y1", d => y1(d.lane) + f)
				.attr("x2", w)
				.attr("y2", d => y1(d.lane) + f)
				.attr("stroke", "lightgray")

			main.append("g").selectAll(".laneText")
				.data(lanes)
				.enter().append("text")
				.text(d => d)
				.attr("x", -m[1])
				.attr("y", (d, i) => y1(i + .5) + f)
				.attr("dy", ".5ex")
				.attr("text-anchor", "end")
				.attr("class", "laneText")

			//mini lanes and texts
			mini.append("g").selectAll(".laneLines")
				.data(items)
				.enter().append("line")
				.attr("t", m[1])
				.attr("y1", d => y2(d.lane) + f)
				.attr("x2", w)
				.attr("y2", d => y2(d.lane) + f)
				.attr("stroke", "lightgray")

			mini.append("g").selectAll(".laneText")
				.data(lanes)
				.enter().append("text")
				.text(d => d)
				.attr("x", -m[1])
				.attr("y", (d, i) => y2(i + .5) + f)
				.attr("dy", ".5ex")
				.attr("text-anchor", "end")
				.attr("class", "laneText")

			var itemRects = main.append("g")
				                .attr("clip-path", "url(#clip)")

			//mini item rects
			mini.append("g").selectAll("miniItems")
				.data(items)
				.enter().append("rect")
				.attr("x", d => x(d.start))
				.attr("y", d => y2(d.lane + .5) + f - (getMiniItemHeight() / 2))
				.attr("width", d => x(d.end) - x(d.start))
				.attr("height", getMiniItemHeight)
				.style("fill", d => "")
				.attr("class", d => `q${d.lane}-${laneLength}`)

			//mini labels
			mini.append("g").selectAll(".miniLabels")
				.data(items)
				.enter().append("text")
				.text(d => d.id)
				.attr("x", d => x(d.start))
				.attr("y", d => y2(d.lane + .5) + f)
				.attr("dy", ".5ex")

			//brush
			var brush = d3.svg.brush()
				          .x(x)
				          .on("brush", display)

			mini.append("g")
				.attr("class", "x brush")
				.call(brush)
				.selectAll("rect")
				.attr("y", 1 + f)
				.attr("height", miniHeight - 7)

			mini.append("g")
				.attr("class", "x axis")
				.attr("transform", `translate(0, ${miniHeight + f})`)
				.call(xAxis)

			display()

			function display() {

				var rects
				var labels
				var minExtent = brush.empty() ? t.domain()[0] : brush.extent()[0]
				var maxExtent = brush.empty() ? t.domain()[1] : brush.extent()[1]
				var visItems = items.filter(d => d.start < maxExtent && d.end > minExtent)

				if (!brush.empty()) {
					mini.select(".brush")
						.call(brush.extent([minExtent, maxExtent]))
				}

				t.domain([minExtent, maxExtent])

				focus.select(".t.axis").call(tAxis)

				//update main item rects
				rects = itemRects.selectAll("rect")
						.data(visItems, d => d.id)
					.attr("x", d => t(d.start))
					.attr("width", d => t(d.end) - t(d.start))

				rects.enter().append("rect")
					.attr("class", d => `q${d.lane}-${laneLength}`)
					.attr("x", d => t(d.start))
					.attr("y", d => y1(d.lane + 0.5) - (getMainItemHeight(d) / 2) + f)
					.attr("width", d => t(d.end) - t(d.start))
					.attr("height", getMainItemHeight)

				rects.exit().remove()

				//update the item labels
				labels = itemRects.selectAll("text")
					.data(visItems, d => d.id)
					.attr("x", d => t(Math.max(d.start, minExtent) + 2))

				labels.enter().append("text")
					.text(d => d.id)
					.attr("x", d => t(Math.max(d.start, minExtent)))
					.attr("y", d => y1(d.lane + .5) + f)
					.attr("text-anchor", "start")

				labels.exit().remove()

			}

		})

		</script>
	</body>
</html>
