<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="description" content="Experiment showing UK's EU Referendum results as arcs.">
		<style type="text/css">

			html, body {
				width: 100%;
				height: 100%;
				padding: 0;
				margin: 0;
			}
			.svg-container {
				display: inline-block;
				position: relative;
				width: 100%;
				height: 100%;
				//padding-bottom: 100%; /* aspect ratio */
				vertical-align: top;
				overflow: hidden;
			}
			.svg-content-responsive {
				display: inline-block;
				position: absolute;
				//top: 10px;
				left: 0;
			}
		</style>
	</head>
	<body>
		<div class="svg-container">
			<svg perserveAspectRatio="xMinYMid" class="svg-content-responsive"></svg>
		</div>
	<script src="d3.v4.min.js"></script>
	<script>
		const tau = 2 * Math.PI // http://tauday.com/tau-manifesto
		const width = window.innerWidth
		const height = window.innerHeight
		const duration = 750
		const delay = 25

		const svg = d3.select("svg")
			.attr("width", `100%`)
			.attr("height", `100%`)
			.attr("viewBox", `0 0 ${Math.min(width, height)} ${Math.min(width, height)}`)
		.append("g")
			.attr("transform", `translate(${Math.min(width, height) / 2}, ${Math.min(width, height) / 2})`)

		const arc = d3.arc()
			//.innerRadius(Math.min(width, height) / 2 - 10)
			//.outerRadius(Math.min(width, height) / 2)

		d3.csv("eu-ref-data.csv", function(error, data) {
			if (error) throw error

			let regionKeys = {}
			let regionArray = []

			data.forEach(function (v, i, a) {
				if (!regionKeys.hasOwnProperty(v.Region)) {
					regionKeys[v.Region] = regionArray.length
					regionArray.push({
						"Area": v.Region,
						"Region": "United Kingdom",
						"Electorate": 0,
						"Remain": 0,
						"Leave": 0
					})
				}
				if (v.Region === v.Area) { v.Area = `${v.Area} (Area)`}
				regionArray[regionKeys[v.Region]]["Electorate"] += +v.Electorate
				regionArray[regionKeys[v.Region]]["Remain"] += +v.Remain
				regionArray[regionKeys[v.Region]]["Leave"] += +v.Leave
			})

			let table = [
				{
					"Area": "root",
					"Electorate": regionArray.reduce((p, c) => p + +c.Electorate, 0),
					"Remain": regionArray.reduce((p, c) => p + +c.Remain, 0),
					"Leave": regionArray.reduce((p, c) => p + +c.Leave, 0)
				},
				{
					"Area": "United Kingdom",
					"Region": "root",
					"Electorate": regionArray.reduce((p, c) => p + +c.Electorate, 0),
					"Remain": regionArray.reduce((p, c) => p + +c.Remain, 0),
					"Leave": regionArray.reduce((p, c) => p + +c.Leave, 0)
				}/*,
			{
				"Area": "root",
				"Region": ""
			}*/].concat(data, regionArray)

			table.forEach(function (v, i, a) {
				v["Actual_Pct_Remain"] = 100 / v["Electorate"] * v["Remain"]
				v["Actual_Pct_Leave"] = 100 / v["Electorate"] * v["Leave"]
			})

			root = d3.stratify()
				.id(d => d.Area)
				.parentId(d => d.Region)
				(table)

			console.log(root)

/*
			var background = g.append("path")
				.datum({
					outerRadius: (((Math.min(width, height) / 2) / root.children[0].data.Electorate) * root.children[0].data.Electorate),
					innerRadius: (((Math.min(width, height) / 2) / root.children[0].data.Electorate) * root.children[0].data.Electorate) - 10,
					startAngle: 0,
					endAngle: tau
				})
				.style("fill", "#ddd")
				.attr("d", arc)

			arc.startAngle(0.5 * tau)

			var remain = g.append("path")
				.datum({
					outerRadius: (((Math.min(width, height) / 2) / root.children[0].data.Electorate) * root.children[0].data.Electorate),
					innerRadius: (((Math.min(width, height) / 2) / root.children[0].data.Electorate) * root.children[0].data.Electorate) - 10,
					endAngle: ((root.children[0].data.Actual_Pct_Remain / 100) + 0.5) * tau
				})
				.style("fill", "yellow")
				.attr("d", arc)

			var leave = g.append("path")
				.datum({
					outerRadius: (((Math.min(width, height) / 2) / root.children[0].data.Electorate) * root.children[0].data.Electorate),
					innerRadius: (((Math.min(width, height) / 2) / root.children[0].data.Electorate) * root.children[0].data.Electorate) - 10,
					endAngle: (0.5 - (root.children[0].data.Actual_Pct_Leave / 100)) * tau
				})
				.style("fill", "blue")
				.attr("d", arc)
*/
			down(root, 0)

			//bar(root)

			function down (d, i) {
				console.log(d)
				if (!d.children || this.__transition__) return

				var end = duration + d.children.length * delay

				// Mark any currently-displayed bars as exiting.
				var exit = svg.selectAll(".enter")
					.attr("class", "exit")

				// Entering nodes immediately obscure the clicked-on bar, so hide it.
				exit.selectAll("path").filter(p => p === d)
					.style("fill-opacity", 1e-6)

				// Enter the new bars for the clicked-on data.
				// Per above, entering bars are immediately visible.
				var enter = bar(d)
					.attr("transform", stack(i))
					.style("opacity", 1)

				// Transition entering bars to their new position.
				var enterTransition = enter.transition()
					.duration(duration)
					.delay((d, i) => i * delay)
					.attr("transform", (d, i) => `translate(0, 0)`)

				// Transition entering text.
				enterTransition.select("text")
					.style("fill-opacity", 1)

				// Transition entering rects to the new x-scale.
				enterTransition.select(".enter")

				// Transition exiting bars to fade out.
				var exitTransition = exit.transition()
					.duration(duration)
					.style("opacity", 1e-6)
					.remove()

				// Transition exiting bars to the new x-scale.
				exitTransition.selectAll("path")

				// Rebind the current node to the background.
				svg.select(".background")
					.datum(d)
					.transition()
					.duration(end)

				d.index = i
			}

			// Creates a set of bars for the given data node, at the specified index.
			function bar (d) {
				//console.log(d)

				let arc = d3.arc()
					//.innerRadius(Math.min(width, height) / 2 - 10)
					//.outerRadius(Math.min(width, height) / 2)

				var circle = svg.insert("g")
					.attr("class", "enter")
					.attr("transform", "translate(0, 0)")
				.selectAll("g")
					.data(d.children)
				.enter().append("g")
					.style("cursor", d => !d.children ? null : "pointer")
					.on("click", down)

				arc.startAngle(0.5 * tau)
					.endAngle(d => {
						console.log("endAngle d", d)
						return ((d.data.Actual_Pct_Remain / 100) + 0.5) * tau
					})
					.outerRadius(d => {
						console.log("outer")
						return (((Math.min(width, height) / 2) / root.data.Electorate) * d.data.Electorate)
					})
					.innerRadius(d => {
						console.log("inner", d.data)
						return (((Math.min(width, height) / 2) / root.data.Electorate) * d.data.Electorate) - 10}
					)

				circle.append("path")
					.attr("class", "remain")
					.style("fill", "yellow")
					.attr("d", arc)

				arc.endAngle(d => {
						console.log("endAngle d", d)
						return (0.5 - (d.data.Actual_Pct_Leave / 100)) * tau
					})

				circle.append("path")
					.attr("class", "leave")
					.style("fill", "blue")
					.attr("d", arc)

					//.data(d)
					/*.datum({
						outerRadius: d => (((Math.min(width, height) / 2) / root.data.Electorate) * d.data.Electorate),
						innerRadius: d => (((Math.min(width, height) / 2) / root.data.Electorate) * d.data.Electorate) - 10,
						endAngle: d => ((d.data.Actual_Pct_Remain / 100) + 0.5) * tau
					})*/

				return circle
			}


			function stack (i) {
				var x0 = 0

				return d => {
					var tx = `translate(0, 0)`
					//x0 += x(d.value)
					return tx
				}
				//return d => d
			}

		})

	</script>
	</body>
</html>
