<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="description" content="Experiment showing UK's EU Referendum results as arcs.">
		<style type="text/css">

			html, body {
				width: 100%;
				height: 100%;
				padding: 0;
				margin: 0;
			}
			.svg-container {
				display: inline-block;
				position: relative;
				width: 100%;
				height: 100%;
				//padding-bottom: 100%; /* aspect ratio */
				vertical-align: top;
				overflow: hidden;
			}
			.svg-content-responsive {
				display: inline-block;
				position: absolute;
				//top: 10px;
				left: 0;
			}
		</style>
	</head>
	<body>
		<div class="svg-container">
			<svg perserveAspectRatio="xMinYMid" class="svg-content-responsive"></svg>
		</div>
	<script src="d3.v4.min.js"></script>
	<script>
		const tau = 2 * Math.PI // http://tauday.com/tau-manifesto
		const width = window.innerWidth
		const height = window.innerHeight

		const svg = d3.select("svg")
			.attr("width", `100%`)
			.attr("height", `100%`)
			.attr("viewBox", `0 0 ${Math.min(width, height)} ${Math.min(width, height)}`)
		const g = svg.append("g").attr("transform", `translate(${Math.min(width, height) / 2}, ${Math.min(width, height) / 2})`)

		const arc = d3.arc()
			.innerRadius(Math.min(width, height) / 2 - 10)
			.outerRadius(Math.min(width, height) / 2)

		d3.csv("eu-ref-data.csv", function(error, data) {
			if (error) throw error

			let regionKeys = {}
			let regionArray = []

			data.forEach(function (v, i, a) {
				if (!regionKeys.hasOwnProperty(v.Region)) {
					regionKeys[v.Region] = regionArray.length
					regionArray.push({
						"Area": v.Region,
						"Region": "United Kingdom",
						"Electorate": 0,
						"Remain": 0,
						"Leave": 0
					})
				}
				if (v.Region === v.Area) { v.Area = `${v.Area} (Area)`}
				regionArray[regionKeys[v.Region]]["Electorate"] += +v.Electorate
				regionArray[regionKeys[v.Region]]["Remain"] += +v.Remain
				regionArray[regionKeys[v.Region]]["Leave"] += +v.Leave
			})

			let table = [{
				"Area": "United Kingdom",
				"Electorate": regionArray.reduce((p, c) => p + +c.Electorate, 0),
				"Remain": regionArray.reduce((p, c) => p + +c.Remain, 0),
				"Leave": regionArray.reduce((p, c) => p + +c.Leave, 0)
			}].concat(data, regionArray)

			table.forEach(function (v, i, a) {
				v["Actual_Pct_Remain"] = 100 / v["Electorate"] * v["Remain"]
				v["Actual_Pct_Leave"] = 100 / v["Electorate"] * v["Leave"]
			})

			root = d3.stratify()
				.id(d => d.Area)
				.parentId(d => d.Region)
				(table)

			console.log(root)


			var background = g.append("path")
				.datum({startAngle: 0, endAngle: tau})
				.style("fill", "#ddd")
				.attr("d", arc)

			arc.startAngle(0.5 * tau)

			var remain = g.append("path")
				.datum({endAngle: ((root.data.Actual_Pct_Remain / 100) + 0.5) * tau})
				.style("fill", "yellow")
				.attr("d", arc)

			var leave = g.append("path")
				.datum({endAngle: (0.5 - (root.data.Actual_Pct_Leave / 100)) * tau})
				.style("fill", "blue")
				.attr("d", arc)

		})

	</script>
	</body>
</html>
